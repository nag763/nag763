<script>
    // Get the API endpoint from environment variables
    const agentApi = import.meta.env.PUBLIC_AGENT_ENDPOINT;
    // Import the 'marked' library for Markdown parsing
    import { marked } from "marked";
    // Generate unique identifiers for the user and session
    const userUuid = crypto.randomUUID();
    const sessionUuid = crypto.randomUUID();

    /**
     * Creates a new chat session for the user by sending a POST request to the backend.
     * @param {string} userUuid - Unique user identifier
     * @param {string} sessionUuid - Unique session identifier
     */
    async function createSession(userUuid, sessionUuid) {
        const options = {
            method: "POST",
            headers: { "Content-Type": "application/json" },
        };

        fetch(
            `${agentApi}/apps/assistant/users/${userUuid}/sessions/${sessionUuid}`,
            options,
        )
            .then((response) => response.json())
            .then((response) => console.log(response))
            .catch((err) => console.error(err));
    }

    /**
     * Appends a chat bubble to the chat window.
     * @param {string} message - The message to display (can be HTML)
     * @param {boolean} end - If true, styles as user message; otherwise, as assistant
     */
    function generateChat(message, end = false) {
        const chatElement = document.getElementById("chat");
        const chatBubble = document.createElement("div");
        // Use different classes for user and assistant messages
        chatBubble.className = `chat chat-${end ? "start" : "end"}`;
        chatBubble.innerHTML = `
            <div class="chat-bubble chat-bubble-${end ? "primary" : "secondary"}">
                ${message}
            </div>
        `;
        chatElement.appendChild(chatBubble);
    }

    /**
     * Sends a message to the backend and handles the response.
     * Disables the input while waiting for the response.
     * @param {string} message - The user's message
     * @param {string} userUuid - User identifier
     * @param {string} sessionUuid - Session identifier
     */
    async function sendMessage(message, userUuid, sessionUuid) {
        const inputElement = document.getElementById("myInput");
        // Disables the input while waiting for the response
        inputElement.disabled = true;
        const options = {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                app_name: "assistant",
                user_id: userUuid,
                session_id: sessionUuid,
                new_message: {
                    role: "user",
                    parts: [
                        {
                            text: message,
                        },
                    ],
                },
            }),
        };

        await fetch(`${agentApi}/run`, options)
            .then((response) => response.json())
            .then((response) =>
                // Parse the assistant's response and display it as a chat bubble
                generateChat(
                    marked.parse(
                        response[response.length - 1]?.content?.parts?.[0]
                            ?.text,
                    ),
                ),
            )
            .catch((err) => {
                // Handle errors and show a fallback message
                console.error(err);
                generateChat(
                    "An error occurred while processing your request.",
                );
            })
            .finally(() => {
                // Re-enables the input after the response is received
                inputElement.disabled = false;
                // Focus the input for the next message
                inputElement.focus();
            });

        return false;
    }

    // Get the input element for user messages
    const inputElement = document.getElementById("myInput");

    // Add event listener to send message on Enter key
    if (inputElement) {
        inputElement.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                // Show user's message in chat
                generateChat(e.target.value, true);
                // Send message to backend
                sendMessage(e.target.value, userUuid, sessionUuid);
                // Clears the current input
                e.target.value = "";
            }
        });
    }

    // Initialize the chat session when the component loads
    await createSession(userUuid, sessionUuid);
    await sendMessage('wave', userUuid, sessionUuid);
</script>
<div class="drawer-side">
    <!-- Hidden chat bubble for layout or accessibility purposes -->
    <div
        class="chat-bubble chat-bubble-secondary chat-bubble-primary chat-end chat-start"
        hidden
    >
    </div>
    <!-- Overlay for closing the sidebar -->
    <label for="my-drawer" aria-label="close sidebar" class="drawer-overlay"
    ></label>
    <div
        class="menu bg-base-200 flex flex-col justify-between text-base-content min-h-full w-1/2 p-4"
    >
        <!-- Chat messages will be appended here -->
        <div id="chat" class="flex flex-col gap-4"></div>
        <div id="typebar" class="grow-0">
            <fieldset class="fieldset w-full">
                <legend class="fieldset-legend">Ask questions</legend>
                <!-- User input for chat -->
                <input
                    type="text"
                    class="input w-full"
                    id="myInput"
                    placeholder="Type here"
                    autocomplete="off"
                />
            </fieldset>
        </div>
    </div>
</div>